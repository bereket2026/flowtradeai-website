<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FlowTradeAI Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
body { margin:0; font-family:Arial, sans-serif; background:#020617; color:#e5e7eb; }
header { padding:20px; border-bottom:1px solid #1e293b; display:flex; justify-content:space-between; align-items:center; }
header h1 { margin:0; color:#22c55e; }
button { background:#22c55e; border:none; padding:10px 16px; border-radius:8px; font-weight:bold; cursor:pointer; }
.container { padding:20px; }
.cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }
.card { background:#0f172a; padding:20px; border-radius:14px; }
.card h3 { margin-top:0; color:#93c5fd; }
h2 { margin-top:30px; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th,td { padding:12px; border-bottom:1px solid #1e293b; text-align:left; }
th { color:#94a3b8; }
.buy { color:#22c55e; }
.sell { color:#ef4444; }
#chart { height:360px; margin-top:20px; background:#0f172a; border-radius:14px; }
</style>
</head>
<body>

<header>
  <h1>FlowTradeAI</h1>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">

  <div class="cards">
    <div class="card"><h3>Balance</h3><h2 id="balance">$0</h2></div>
    <div class="card"><h3>Total PnL</h3><h2 id="pnl">$0</h2></div>
  </div>

  <div style="margin-top:20px;">
    <button onclick="startAutoTrade()">Start Auto Trade</button>
    <button onclick="stopAutoTrade()" style="background:#ef4444;margin-left:10px;">Stop</button>
    <span id="tradeStatus" style="margin-left:15px;color:#94a3b8;"></span>
  </div>

  <h2>BTC / USDT â€” 5m Candlesticks</h2>
  <div id="chart"></div>

  <h2>AI Signals</h2>
  <table>
    <thead>
      <tr><th>Pair</th><th>Signal</th><th>Confidence</th><th>Price</th></tr>
    </thead>
    <tbody id="signals"></tbody>
  </table>

</div>

<script>
const API = "https://flowtradeai-backend-v3.onrender.com";
const TOKEN = localStorage.getItem("token");
if (!TOKEN) window.location.href = "login.html";

async function loadAccount(){
  try{
    const r = await fetch(API+"/account",{headers:{Authorization:TOKEN}});
    const d = await r.json();
    document.getElementById("balance").innerText = "$"+d.balance;
    document.getElementById("pnl").innerText = "$"+d.total_pnl;
  }catch(e){console.log(e);}
}

async function loadSignals(){
  try{
    const r = await fetch(API+"/ai-signal",{headers:{Authorization:TOKEN}});
    const data = await r.json();
    const tbody = document.getElementById("signals");
    tbody.innerHTML="";
    data.forEach(s=>{
      const cls = s.signal==="BUY"?"buy":"sell";
      tbody.innerHTML += `<tr><td>${s.pair}</td><td class="${cls}">${s.signal}</td><td>${s.confidence}%</td><td>${s.price}</td></tr>`;
    });
    drawMarkers(data);
  }catch(e){console.log(e);}
}

const chart = LightweightCharts.createChart(document.getElementById("chart"),{
  layout:{background:{color:"#0f172a"},textColor:"#e5e7eb"},
  grid:{vertLines:{color:"#1e293b"},horzLines:{color:"#1e293b"}},
  timeScale:{timeVisible:true}
});

const candleSeries = chart.addCandlestickSeries({
  upColor:"#22c55e", downColor:"#ef4444", borderVisible:false,
  wickUpColor:"#22c55e", wickDownColor:"#ef4444"
});

async function loadCandles(){
  try{
    const r = await fetch("https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=5m&limit=100");
    const data = await r.json();
    const candles = data.map(c=>({time:c[0]/1000,open:+c[1],high:+c[2],low:+c[3],close:+c[4]}));
    candleSeries.setData(candles);
  }catch(e){console.log(e);}
}

function drawMarkers(signalsData){
  const markers = signalsData.map(s=>({
    time:Math.floor(Date.now()/1000),
    position:s.signal==="BUY"?"belowBar":"aboveBar",
    color:s.signal==="BUY"?"#22c55e":"#ef4444",
    shape:s.signal==="BUY"?"arrowUp":"arrowDown",
    text:s.signal
  }));
  candleSeries.setMarkers(markers);
}

async function startAutoTrade(){ await fetch(API+"/auto-trade/start",{method:"POST"}); checkTradeStatus(); }
async function stopAutoTrade(){ await fetch(API+"/auto-trade/stop",{method:"POST"}); checkTradeStatus(); }

async function checkTradeStatus(){
  const r = await fetch(API+"/auto-trade/status");
  const d = await r.json();
  document.getElementById("tradeStatus").innerText = d.running?"ðŸŸ¢ Auto-Trading ON":"ðŸ”´ Auto-Trading OFF";
}

function logout(){ localStorage.removeItem("token"); window.location.href="login.html"; }

loadAccount(); loadSignals(); loadCandles(); checkTradeStatus();
setInterval(loadAccount,15000);
setInterval(loadSignals,8000);
setInterval(loadCandles,30000);
setInterval(checkTradeStatus,5000);
</script>

</body>
</html>
