import ccxt
import time
import threading
import jwt
import datetime
from flask import Flask, request, jsonify
from flask_sqlalchemy import SQLAlchemy
from flask_cors import CORS
from werkzeug.security import generate_password_hash, check_password_hash

# ================= APP SETUP =================
app = Flask(__name__)
CORS(app)

app.config['SECRET_KEY'] = 'flowtradeai-secret'
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///flowtradeai.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)

# ================= MODELS =================
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    email = db.Column(db.String(120), unique=True)
    password = db.Column(db.String(200))


class APIKey(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer)
    exchange = db.Column(db.String(20))
    api_key = db.Column(db.String(200))
    api_secret = db.Column(db.String(200))


class AutoBot(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer)
    symbol = db.Column(db.String(20))
    amount = db.Column(db.Float)
    active = db.Column(db.Boolean, default=True)


# ================= AUTH HELPERS =================
def create_token(user_id):
    return jwt.encode({
        'user_id': user_id,
        'exp': datetime.datetime.utcnow() + datetime.timedelta(days=7)
    }, app.config['SECRET_KEY'], algorithm="HS256")


def verify_token(token):
    try:
        data = jwt.decode(token, app.config['SECRET_KEY'], algorithms=["HS256"])
        return data['user_id']
    except:
        return None


# ================= AUTH ROUTES =================
@app.route("/register", methods=["POST"])
def register():
    data = request.json
    email = data.get("email")
    password = data.get("password")

    if User.query.filter_by(email=email).first():
        return jsonify({"error": "User already exists"}), 400

    hashed = generate_password_hash(password)
    user = User(email=email, password=hashed)
    db.session.add(user)
    db.session.commit()

    return jsonify({"message": "Registered successfully"})


@app.route("/login", methods=["POST"])
def login():
    data = request.json
    email = data.get("email")
    password = data.get("password")

    user = User.query.filter_by(email=email).first()
    if not user or not check_password_hash(user.password, password):
        return jsonify({"error": "Invalid credentials"}), 401

    token = create_token(user.id)
    return jsonify({"token": token})


# ================= EXCHANGE =================
def connect_exchange(api_key, api_secret):
    return ccxt.binance({
        'apiKey': api_key,
        'secret': api_secret,
        'enableRateLimit': True,
        'options': {'defaultType': 'spot'}
    })


# ================= AI SIGNAL (PLACEHOLDER) =================
def ai_signal(symbol):
    import random
    return random.choice(['buy', 'sell', None])


# ================= AUTO TRADE CONTROL =================
auto_trade_enabled = False


@app.route("/auto-trade/start", methods=["POST"])
def start_auto_trade():
    global auto_trade_enabled
    auto_trade_enabled = True
    return jsonify({"status": "started"})


@app.route("/auto-trade/stop", methods=["POST"])
def stop_auto_trade():
    global auto_trade_enabled
    auto_trade_enabled = False
    return jsonify({"status": "stopped"})


@app.route("/auto-trade/status")
def auto_trade_status():
    return jsonify({"running": auto_trade_enabled})


# ================= PROTECTED DATA =================
@app.route("/account")
def account():
    token = request.headers.get("Authorization")
    user_id = verify_token(token)
    if not user_id:
        return jsonify({"error": "Unauthorized"}), 401

    return jsonify({"balance": 1000, "total_pnl": 25})


@app.route("/ai-signal")
def signals():
    token = request.headers.get("Authorization")
    user_id = verify_token(token)
    if not user_id:
        return jsonify({"error": "Unauthorized"}), 401

    return jsonify([
        {"pair": "BTC/USDT", "signal": "BUY", "confidence": 72, "price": 43000},
        {"pair": "ETH/USDT", "signal": "SELL", "confidence": 64, "price": 2300},
    ])


# ================= AUTO TRADING LOOP =================
def run_autobots():
    global auto_trade_enabled

    with app.app_context():
        while True:
            if not auto_trade_enabled:
                time.sleep(5)
                continue

            bots = AutoBot.query.filter_by(active=True).all()

            for bot in bots:
                key = APIKey.query.filter_by(user_id=bot.user_id).first()
                if not key:
                    continue

                exchange = connect_exchange(key.api_key, key.api_secret)
                signal = ai_signal(bot.symbol)

                try:
                    if signal == 'buy':
                        exchange.create_market_buy_order(bot.symbol, bot.amount)
                    elif signal == 'sell':
                        exchange.create_market_sell_order(bot.symbol, bot.amount)
                except Exception as e:
                    print('Trade error:', e)

            time.sleep(60)


# ================= START BACKGROUND BOT =================
def start_bot_thread():
    thread = threading.Thread(target=run_autobots, daemon=True)
    thread.start()


# ================= MAIN =================
if __name__ == '__main__':
    with app.app_context():
        db.create_all()

    start_bot_thread()
    app.run(host='0.0.0.0', port=5000)
